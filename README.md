# High-performance Communicating Architecture #
# 高性能通信架构 #

## 综述 ##
 本项目实现了高性能接入层服务器，从消息吞吐量、并发时延、客户端连接速率三方面，提供性能测试数据指标。

## 性能测试数据 ##
### 测试环境 ###
 * Win10 PC安装的Linux虚拟机：X64 OpenSuse 15.2
 * 虚拟机CPU: AMD Ryzen 5 5600G[4核心]
 * 虚拟机内存: 4GB
 * fd句柄限制数：100,0000
 * socket缓冲区大小：Default
 * 部署方式：(1)客户端、服务端在同虚拟机部署. (2)分别在两台虚拟机中部署.

### 测试基准 ###
 * 消息长度: 总长1024字节，包头长度16字节。  
 * 消息处理方式：校验包头、计数再转发。
 
### 测试吞吐量[throughput]：~ 30万(300,000) TPS
 * 发包方式：每秒发送指定个数。
 * 消息路径：[client -> server -> client]
 * 一个往返后消息释放，记一次；统计每4百万(4,000,000)次的收包间隔。

#### 场景1 ####
  * 1个socket连接，初始发送 1000个包，统计处理4,000,000次的收包间隔
  * 测试结果：(1)同机部署，小于10秒; (2)两机部署，小于15秒。
  * 计算吞吐量: (1)同机达到300,000 tps以上; (2)两机达到200,000 tps以上。
  * 客户端/服务端 程序内存均维持在500MB以内，cpu均维持在200%以内。

### 测试最小时延：~230微秒 ###
 * 消息路径：一个往返记一次，消息继续循环。
 
#### 场景1 ####
 * 1个socket客户端，初始发送1个消息包，统计客收包间隔
  * 测试结果：
  * 同机部署，平均10s/65536次，时延约为160us。
  * 两机部署，平均45s/65536次，时延约为620us。
  
#### 场景2 ####
 * 1000个socket客户端，初始各自发送1个消息包，统计4,000,000次的收包间隔
  * 测试结果：
  * 同机部署，平均40s/4194304, 约为100,000 tps
  * 两机部署，平均60s/4194304, 约为69,000 tps
 
#### 场景3 ####
 * 1个socket客户端，初始发送10000个消息包，统计4,000,000次的收包间隔
  * 测试结果：
  * 同机部署：平均4s/4194304，约为 1,000,000 tps。
  * 两机部署：平均15s/4194304，约为700,000 tps.
  
### 测试客户端连接速率： ###
 * 环境变量：nofile=1,000,000, somaxconn=tcp\_max\_syn\_backlog=10000
#### 场景 ####
 * 客户端并发启动1万(20,000)个连接，统计完成时间。
  * 测试结果：
  * 同机部署，在1.5秒内全部连接，开始收发包。
  * 两机部署，连接完成后系统会陆续关闭，不稳定，忽略测试结果。
  * 采用异步connect模式。

### 修改及效果说明 ###
新版本抛弃了无锁设计，采用自旋锁及事件方式实现数据的同步和临界资源的保护。前版本尝试无锁设计，极大提高了程序的复杂度，后续测试中也发现了相关的不稳定性及bug缺陷；由于理解有限不能解决，因此放弃。另外，新版中对门控制细节做了优化，同时在线程运行方式上采用更为统一高效的方式，新版从测试结果看，性能实现预期。
 
## 结束语 ##   
 **The End: No pain, No gain. Show me the Performance!!**  
 
 
                               
